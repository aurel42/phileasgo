=== RUN   TestEssayHandler_SelectTopic
2026/02/01 15:21:57 INFO EssayHandler: Topic pool exhausted. Starting new rotation cycle. topics=3
2026/02/01 15:21:57 INFO EssayHandler: Topic pool exhausted. Starting new rotation cycle. topics=3
--- PASS: TestEssayHandler_SelectTopic (0.00s)
=== RUN   TestEssayHandler_BuildPrompt
--- PASS: TestEssayHandler_BuildPrompt (0.00s)
=== RUN   TestEssayHandler_BuildPrompt_CoordinatesPassthrough
--- PASS: TestEssayHandler_BuildPrompt_CoordinatesPassthrough (0.00s)
=== RUN   TestNewEssayHandler_NotFound
--- PASS: TestNewEssayHandler_NotFound (0.00s)
=== RUN   TestSelectTopic_EmptyConfig
--- PASS: TestSelectTopic_EmptyConfig (0.00s)
=== RUN   TestNewLLMProvider
=== RUN   TestNewLLMProvider/Gemini_Provider
2026/02/01 15:21:57 WARN Gemini model validation failed (proceeding due to TEST_MODE) error="no profiles configured for gemini provider"
=== RUN   TestNewLLMProvider/Unknown_Provider
--- PASS: TestNewLLMProvider (0.00s)
    --- PASS: TestNewLLMProvider/Gemini_Provider (0.00s)
    --- PASS: TestNewLLMProvider/Unknown_Provider (0.00s)
=== RUN   TestNewTTSProvider
=== RUN   TestNewTTSProvider/SAPI_Provider
=== RUN   TestNewTTSProvider/Edge_TTS_Provider
=== RUN   TestNewTTSProvider/Fish_Audio_Provider
=== RUN   TestNewTTSProvider/Azure_Speech_Provider
=== RUN   TestNewTTSProvider/Unknown_Provider
--- PASS: TestNewTTSProvider (0.00s)
    --- PASS: TestNewTTSProvider/SAPI_Provider (0.00s)
    --- PASS: TestNewTTSProvider/Edge_TTS_Provider (0.00s)
    --- PASS: TestNewTTSProvider/Fish_Audio_Provider (0.00s)
    --- PASS: TestNewTTSProvider/Azure_Speech_Provider (0.00s)
    --- PASS: TestNewTTSProvider/Unknown_Provider (0.00s)
=== RUN   TestLatencyTracking
--- PASS: TestLatencyTracking (0.00s)
=== RUN   TestBorderBeaconExemption
    orchestrator_features_test.go:53: PlayNarrative failed: already active
--- FAIL: TestBorderBeaconExemption (0.00s)
=== RUN   TestOrchestrator_Pause
--- PASS: TestOrchestrator_Pause (0.00s)
=== RUN   TestOrchestrator_ReplayLast
=== RUN   TestOrchestrator_ReplayLast/Replay_last_POI_success
=== RUN   TestOrchestrator_ReplayLast/Audio_replay_fails
=== RUN   TestOrchestrator_ReplayLast/Replay_with_no_state_(fallback)
--- PASS: TestOrchestrator_ReplayLast (0.00s)
    --- PASS: TestOrchestrator_ReplayLast/Replay_last_POI_success (0.00s)
    --- PASS: TestOrchestrator_ReplayLast/Audio_replay_fails (0.00s)
    --- PASS: TestOrchestrator_ReplayLast/Replay_with_no_state_(fallback) (0.00s)
=== RUN   TestAIService_HandleTTSError
2026/02/01 15:21:57 ERROR Narrator: TTS synthesis failed error="rate limited"
2026/02/01 15:21:57 WARN Narrator: Activating edge-tts fallback for this session
2026/02/01 15:21:57 WARN Narrator: Skipping current POI (script incompatible with fallback TTS). Will retry with next POI.
--- PASS: TestAIService_HandleTTSError (0.00s)
=== RUN   TestAIService_PlayEssay
=== RUN   TestAIService_PlayEssay/Happy_Path
2026/02/01 15:21:57 INFO AI Narrator service started
2026/02/01 15:21:57 INFO Narrator: Triggering Essay
2026/02/01 15:21:57 INFO EssayHandler: Topic pool exhausted. Starting new rotation cycle. topics=1
2026/02/01 15:21:57 INFO Narrator: Narrating Essay topic="History of Flight"
=== RUN   TestAIService_PlayEssay/LLM_Error
2026/02/01 15:21:58 INFO AI Narrator service started
2026/02/01 15:21:58 INFO Narrator: Triggering Essay
2026/02/01 15:21:58 INFO EssayHandler: Topic pool exhausted. Starting new rotation cycle. topics=1
2026/02/01 15:21:58 INFO Narrator: Narrating Essay topic="History of Flight"
2026/02/01 15:21:58 ERROR Narrator: Essay generation failed error="LLM generation failed: llm fail"
--- PASS: TestAIService_PlayEssay (0.20s)
    --- PASS: TestAIService_PlayEssay/Happy_Path (0.10s)
    --- PASS: TestAIService_PlayEssay/LLM_Error (0.10s)
=== RUN   TestAIService_PlayEssay_NoHandler
--- PASS: TestAIService_PlayEssay_NoHandler (0.00s)
=== RUN   TestAIService_AnnouncementFallback
=== RUN   TestAIService_AnnouncementFallback/Letsgo_uses_specific_profile_if_available
=== RUN   TestAIService_AnnouncementFallback/Letsgo_falls_back_to_announcements
=== RUN   TestAIService_AnnouncementFallback/Briefing_falls_back_to_announcements
=== RUN   TestAIService_AnnouncementFallback/Debrief_is_NOT_an_announcement_(no_fallback)
=== RUN   TestAIService_AnnouncementFallback/Screenshot_is_NOT_an_announcement_(no_fallback)
=== RUN   TestAIService_AnnouncementFallback/Border_is_NOT_an_announcement_(no_fallback)
--- PASS: TestAIService_AnnouncementFallback (0.00s)
    --- PASS: TestAIService_AnnouncementFallback/Letsgo_uses_specific_profile_if_available (0.00s)
    --- PASS: TestAIService_AnnouncementFallback/Letsgo_falls_back_to_announcements (0.00s)
    --- PASS: TestAIService_AnnouncementFallback/Briefing_falls_back_to_announcements (0.00s)
    --- PASS: TestAIService_AnnouncementFallback/Debrief_is_NOT_an_announcement_(no_fallback) (0.00s)
    --- PASS: TestAIService_AnnouncementFallback/Screenshot_is_NOT_an_announcement_(no_fallback) (0.00s)
    --- PASS: TestAIService_AnnouncementFallback/Border_is_NOT_an_announcement_(no_fallback) (0.00s)
=== RUN   TestScreenshotCoordinatesPersistence
--- PASS: TestScreenshotCoordinatesPersistence (0.00s)
=== RUN   TestAIService_GenerateNarrative_ProfileAndWords
=== RUN   TestAIService_GenerateNarrative_ProfileAndWords/POI_Narration_-_Uses_narration_profile
=== RUN   TestAIService_GenerateNarrative_ProfileAndWords/Screenshot_Analysis_-_Uses_screenshot_profile_and_image
=== RUN   TestAIService_GenerateNarrative_ProfileAndWords/Regional_Essay_-_Uses_essay_profile
=== RUN   TestAIService_GenerateNarrative_ProfileAndWords/Flight_Debrief_-_Uses_debrief_profile
--- PASS: TestAIService_GenerateNarrative_ProfileAndWords (0.00s)
    --- PASS: TestAIService_GenerateNarrative_ProfileAndWords/POI_Narration_-_Uses_narration_profile (0.00s)
    --- PASS: TestAIService_GenerateNarrative_ProfileAndWords/Screenshot_Analysis_-_Uses_screenshot_profile_and_image (0.00s)
    --- PASS: TestAIService_GenerateNarrative_ProfileAndWords/Regional_Essay_-_Uses_essay_profile (0.00s)
    --- PASS: TestAIService_GenerateNarrative_ProfileAndWords/Flight_Debrief_-_Uses_debrief_profile (0.00s)
=== RUN   TestAIService_GenerateNarrative_RescueAvoidance
=== RUN   TestAIService_GenerateNarrative_RescueAvoidance/No_Rescue_when_within_buffer
=== RUN   TestAIService_GenerateNarrative_RescueAvoidance/Rescue_triggered_when_significantly_over
2026/02/01 15:21:58 WARN Narrator: Script exceeded limit, attempting rescue requested=10 actual=21
2026/02/01 15:21:58 INFO Narrator: Script rescue successful original=21 rescued=2
--- PASS: TestAIService_GenerateNarrative_RescueAvoidance (0.00s)
    --- PASS: TestAIService_GenerateNarrative_RescueAvoidance/No_Rescue_when_within_buffer (0.00s)
    --- PASS: TestAIService_GenerateNarrative_RescueAvoidance/Rescue_triggered_when_significantly_over (0.00s)
=== RUN   TestAIService_ExtractTitleFromScript
=== RUN   TestAIService_ExtractTitleFromScript/Standard_Title
=== RUN   TestAIService_ExtractTitleFromScript/Markdown_Bold_Title
=== RUN   TestAIService_ExtractTitleFromScript/Case_Insensitive_Title
=== RUN   TestAIService_ExtractTitleFromScript/No_Title
=== RUN   TestAIService_ExtractTitleFromScript/Title_Only
=== RUN   TestAIService_ExtractTitleFromScript/Indented_Title
=== RUN   TestAIService_ExtractTitleFromScript/Title_with_asterisk_suffix
--- PASS: TestAIService_ExtractTitleFromScript (0.00s)
    --- PASS: TestAIService_ExtractTitleFromScript/Standard_Title (0.00s)
    --- PASS: TestAIService_ExtractTitleFromScript/Markdown_Bold_Title (0.00s)
    --- PASS: TestAIService_ExtractTitleFromScript/Case_Insensitive_Title (0.00s)
    --- PASS: TestAIService_ExtractTitleFromScript/No_Title (0.00s)
    --- PASS: TestAIService_ExtractTitleFromScript/Title_Only (0.00s)
    --- PASS: TestAIService_ExtractTitleFromScript/Indented_Title (0.00s)
    --- PASS: TestAIService_ExtractTitleFromScript/Title_with_asterisk_suffix (0.00s)
=== RUN   TestAIService_RescueScript
--- PASS: TestAIService_RescueScript (0.00s)
=== RUN   TestAIService_PlayPOI_Constraints
2026/02/01 15:21:58 INFO Narrator: Manual generation requested poi_id=Q123
2026/02/01 15:21:58 INFO Narrator: Manual generation requested poi_id=Q789
--- PASS: TestAIService_PlayPOI_Constraints (0.00s)
=== RUN   TestOrchestrator_QueueManagement
--- PASS: TestOrchestrator_QueueManagement (0.00s)
=== RUN   TestAIService_QueueCallback
--- PASS: TestAIService_QueueCallback (0.00s)
=== RUN   TestAIService_ManualOverrides
--- PASS: TestAIService_ManualOverrides (0.00s)
=== RUN   TestOrchestrator_StateGetters
--- PASS: TestOrchestrator_StateGetters (0.00s)
=== RUN   TestAIService_StateChecks
--- PASS: TestAIService_StateChecks (0.00s)
=== RUN   TestAIService_POIBusy
--- PASS: TestAIService_POIBusy (0.00s)
=== RUN   TestAIService_StatsAndLatency
--- PASS: TestAIService_StatsAndLatency (0.00s)
=== RUN   TestAIService_NarratedCount
--- PASS: TestAIService_NarratedCount (0.00s)
=== RUN   TestAIService_PlayPOI
=== RUN   TestAIService_PlayPOI/Happy_Path
2026/02/01 15:21:58 INFO AI Narrator service started
2026/02/01 15:21:58 INFO Narrator: Manual generation requested poi_id=Q1
=== RUN   TestAIService_PlayPOI/POI_Not_Found
2026/02/01 15:21:58 INFO AI Narrator service started
2026/02/01 15:21:58 INFO Narrator: Manual generation requested poi_id=QMISSING
2026/02/01 15:21:58 ERROR Narrator: Priority job failed - POI not found poi_id=QMISSING
=== RUN   TestAIService_PlayPOI/LLM_Failure
2026/02/01 15:21:58 INFO AI Narrator service started
2026/02/01 15:21:58 INFO Narrator: Manual generation requested poi_id=Q2
2026/02/01 15:21:58 ERROR Narrator: Priority generation failed type=poi error="LLM generation failed: llm fail"
=== RUN   TestAIService_PlayPOI/TTS_Failure
2026/02/01 15:21:58 INFO AI Narrator service started
2026/02/01 15:21:58 INFO Narrator: Manual generation requested poi_id=Q3
2026/02/01 15:21:58 ERROR Narrator: TTS synthesis failed error="tts fail"
2026/02/01 15:21:58 ERROR Narrator: Priority generation failed type=poi error="TTS synthesis failed: tts fail"
=== RUN   TestAIService_PlayPOI/Wikipedia_Fetch
2026/02/01 15:21:58 INFO AI Narrator service started
2026/02/01 15:21:58 INFO Narrator: Manual generation requested poi_id=QWiki
--- PASS: TestAIService_PlayPOI (1.00s)
    --- PASS: TestAIService_PlayPOI/Happy_Path (0.20s)
    --- PASS: TestAIService_PlayPOI/POI_Not_Found (0.20s)
    --- PASS: TestAIService_PlayPOI/LLM_Failure (0.20s)
    --- PASS: TestAIService_PlayPOI/TTS_Failure (0.20s)
    --- PASS: TestAIService_PlayPOI/Wikipedia_Fetch (0.20s)
=== RUN   TestAIService_ContextAndNav_V2
=== RUN   TestAIService_ContextAndNav_V2/With_Nav_Instruction
2026/02/01 15:21:59 INFO AI Narrator service started
2026/02/01 15:21:59 INFO Narrator: Manual generation requested poi_id=QNav
=== RUN   TestAIService_ContextAndNav_V2/With_Recent_POIs
2026/02/01 15:21:59 INFO AI Narrator service started
2026/02/01 15:21:59 INFO Narrator: Manual generation requested poi_id=QCurrent
--- PASS: TestAIService_ContextAndNav_V2 (0.11s)
    --- PASS: TestAIService_ContextAndNav_V2/With_Nav_Instruction (0.05s)
    --- PASS: TestAIService_ContextAndNav_V2/With_Recent_POIs (0.05s)
=== RUN   TestAIService_Lifecycle
2026/02/01 15:21:59 INFO AI Narrator service started
2026/02/01 15:21:59 INFO AI Narrator service stopped
--- PASS: TestAIService_Lifecycle (0.00s)
=== RUN   TestAIService_NavUnits
=== RUN   TestAIService_NavUnits/Imperial_Default_(>1_mile)
2026/02/01 15:21:59 INFO AI Narrator service started
2026/02/01 15:21:59 INFO Narrator: Manual generation requested poi_id=Q8080
=== RUN   TestAIService_NavUnits/Metric_(>1_km)
2026/02/01 15:21:59 INFO AI Narrator service started
2026/02/01 15:21:59 INFO Narrator: Manual generation requested poi_id=Q8080
--- PASS: TestAIService_NavUnits (0.11s)
    --- PASS: TestAIService_NavUnits/Imperial_Default_(>1_mile) (0.05s)
    --- PASS: TestAIService_NavUnits/Metric_(>1_km) (0.05s)
=== RUN   TestAIService_GeneratePlay
--- PASS: TestAIService_GeneratePlay (0.00s)
=== RUN   TestAIService_SummarizeAndLogEvent
--- PASS: TestAIService_SummarizeAndLogEvent (0.00s)
=== RUN   TestAIService_LatencyTracking
--- PASS: TestAIService_LatencyTracking (0.05s)
=== RUN   TestAIService_PipelineFlow
=== RUN   TestAIService_PipelineFlow/Happy_Path:_Consumes_Staged
2026/02/01 15:21:59 INFO Narrator: Manual generation requested poi_id=QStaged
=== RUN   TestAIService_PipelineFlow/No_Staged_Data_->_Generates_Fresh
2026/02/01 15:21:59 INFO Narrator: Manual generation requested poi_id=QFresh
--- PASS: TestAIService_PipelineFlow (0.20s)
    --- PASS: TestAIService_PipelineFlow/Happy_Path:_Consumes_Staged (0.10s)
    --- PASS: TestAIService_PipelineFlow/No_Staged_Data_->_Generates_Fresh (0.10s)
=== RUN   TestAIService_ScriptValidation
2026/02/01 15:21:59 WARN Narrator: Script exceeded limit, attempting rescue requested=200 actual=1000
2026/02/01 15:21:59 ERROR Narrator: Script rescue failed, using original error="failed to render rescue prompt: template: no template \"context/rescue_script.tmpl\" associated with template \"root\""
--- PASS: TestAIService_ScriptValidation (0.00s)
=== RUN   TestAllProductionTemplatesExecuteSuccessfully
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/announcement/border.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/announcement/briefing.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/announcement/debriefing.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/announcement/letsgo.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/announcement/screenshot.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/category/aerodrome.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/category/city.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/category/nature.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/category/water.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/context/accent.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/context/pregrounding.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/context/rescue_script.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/context/thumbnail_selector.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/context/wikidata.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/narrator/essay.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/narrator/event_summary.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/narrator/readout.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/narrator/script.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/narrator/script_full.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/narrator/script_stub.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/tts/azure.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/tts/edge-tts.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/tts/fish-audio.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/units/hybrid.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/units/imperial.tmpl
=== RUN   TestAllProductionTemplatesExecuteSuccessfully/units/metric.tmpl
--- PASS: TestAllProductionTemplatesExecuteSuccessfully (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/announcement/border.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/announcement/briefing.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/announcement/debriefing.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/announcement/letsgo.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/announcement/screenshot.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/category/aerodrome.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/category/city.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/category/nature.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/category/water.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/context/accent.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/context/pregrounding.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/context/rescue_script.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/context/thumbnail_selector.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/context/wikidata.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/narrator/essay.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/narrator/event_summary.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/narrator/readout.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/narrator/script.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/narrator/script_full.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/narrator/script_stub.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/tts/azure.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/tts/edge-tts.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/tts/fish-audio.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/units/hybrid.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/units/imperial.tmpl (0.00s)
    --- PASS: TestAllProductionTemplatesExecuteSuccessfully/units/metric.tmpl (0.00s)
=== RUN   TestAIService_TTSFallback
2026/02/01 15:21:59 WARN Narrator: Activating edge-tts fallback for this session
--- PASS: TestAIService_TTSFallback (0.00s)
=== RUN   TestAIService_SkipCooldown
--- PASS: TestAIService_SkipCooldown (0.00s)
=== RUN   TestStubService_Lifecycle
2026/02/01 15:21:59 INFO Narrator stub service started
2026/02/01 15:21:59 INFO Narrator stub service stopped
--- PASS: TestStubService_Lifecycle (0.00s)
=== RUN   TestStubService_PlayPOI
2026/02/01 15:21:59 INFO Narrator stub: manual play requested poi_id=Q1
--- PASS: TestStubService_PlayPOI (0.00s)
=== RUN   TestStubService_PlayEssay
2026/02/01 15:21:59 INFO Narrator stub: essay play requested
--- PASS: TestStubService_PlayEssay (0.00s)
=== RUN   TestStubService_Cooldown
--- PASS: TestStubService_Cooldown (0.00s)
=== RUN   TestStubService_Stats
--- PASS: TestStubService_Stats (0.00s)
=== RUN   TestStubService_Getters
--- PASS: TestStubService_Getters (0.00s)
=== RUN   TestNarrator_Integration
    integration_test.go:65: Successfully rendered template. Preview:
        You are an expert for the region Ile-de-France in France.
        
        You are creating a script for a tour gu...
--- PASS: TestNarrator_Integration (0.00s)
FAIL
FAIL	phileasgo/pkg/narrator	1.776s
FAIL
